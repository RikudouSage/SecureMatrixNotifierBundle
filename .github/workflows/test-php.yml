name: Test PHP library

on:
  push:
    branches:
      - master
  pull_request: {}
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  tests:
    name: Run PHPUnit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: ffi
          coverage: xdebug
      - name: Validate composer.json
        run: composer validate --no-interaction --no-check-publish
      - name: Install dependencies
        run: composer install --no-interaction --no-progress --prefer-dist
      - name: Run PHPUnit with coverage
        run: php -d xdebug.mode=coverage ./vendor/bin/phpunit --coverage-cobertura=coverage.xml --coverage-text
      - name: Generate coverage summary
        if: always() && hashFiles('coverage.xml') != ''
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          format: markdown
          output: file
      - name: Comment coverage summary on PR
        if: github.event_name == 'pull_request' && hashFiles('coverage.xml') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          recreate: true
          path: code-coverage-results.md
